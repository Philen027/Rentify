<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rentify Partner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; }

    /* VERIFICATION MODE (Video BG) */
    .bg-video-mode { background-color: #020617; color: white; }
    .video-bg { position: fixed; top: 50%; left: 50%; min-width: 100%; min-height: 100%; width: auto; height: auto; z-index: -10; transform: translate(-50%, -50%); object-fit: cover; }
    .video-overlay { position: fixed; inset: 0; z-index: -5; background: radial-gradient(circle at 50% 50%, rgba(2, 6, 23, 0.6) 0%, rgba(2, 6, 23, 0.95) 90%); }
    .glass-modal { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); }
    
    /* DASHBOARD MODE (Green/Clean) */
    .bg-dashboard-mode { background-color: #F8FAFC; color: #1F2937; }
    .nav-item.active { background-color: #064E3B; color: white; box-shadow: 0 4px 12px rgba(6, 78, 59, 0.3); }
    .hidden-force { display: none !important; }
  </style>
</head>
<body id="main-body" class="bg-video-mode h-screen overflow-hidden">

  <div id="view-verification" class="flex flex-col items-center justify-center h-full p-4 relative w-full">
      <video autoplay muted loop playsinline class="video-bg"><source src="Video_Generation_Request.mp4" type="video/mp4"></video>
      <div class="video-overlay"></div>

      <div id="state-loading" class="text-center">
          <i class="fa-solid fa-circle-notch fa-spin text-4xl text-emerald-500 mb-4"></i>
          <h2 class="text-xl font-medium tracking-wide">Connecting...</h2>
      </div>

      <div id="state-form" class="hidden-force w-full max-w-xl glass-modal rounded-3xl p-8 animate-fade-in">
          <div class="mb-6"><h1 class="text-2xl font-bold">Partner Application</h1><p class="text-slate-400 text-sm">Submit details to activate your seller account.</p></div>
          <form id="form-verify" class="space-y-4">
              <input type="text" id="v-biz-name" required class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none" placeholder="Business Name">
              <input type="text" id="v-biz-addr" required class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none" placeholder="Location">
              <div class="p-4 bg-slate-800/50 rounded-xl border border-dashed border-slate-600">
                  <label class="block text-xs font-bold text-slate-400 uppercase mb-2">ID Proof (Auto-Compressed &lt; 50KB)</label>
                  <input type="file" id="v-file-doc" required accept="image/*" class="text-sm text-slate-400 w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white cursor-pointer">
              </div>
              <button type="submit" id="btn-submit-app" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transition">Submit Application</button>
          </form>
          <button onclick="logout()" class="w-full mt-4 text-xs text-slate-500 hover:text-white">Cancel & Logout</button>
      </div>

      <div id="state-pending" class="hidden-force text-center max-w-md glass-modal p-10 rounded-3xl">
          <i class="fa-solid fa-clock text-4xl text-yellow-400 mb-4"></i>
          <h2 class="text-2xl font-bold mb-2">Verification Pending</h2>
          <p class="text-slate-400 mb-6 text-sm">Your application has been sent to the admin. Please wait for approval.</p>
          <button onclick="location.reload()" class="px-6 py-2 bg-white/10 hover:bg-white/20 rounded-full text-sm font-medium transition">Refresh Status</button>
          <div class="mt-4"><button onclick="logout()" class="text-xs text-slate-500 hover:text-white">Logout</button></div>
      </div>
  </div>

  <div id="view-dashboard" class="hidden-force flex h-screen overflow-hidden">
      <aside class="w-64 bg-white border-r border-slate-100 flex flex-col p-6 hidden md:flex">
        <div class="flex items-center gap-3 mb-10"><div class="w-8 h-8 bg-green-100 text-green-700 rounded-lg flex items-center justify-center font-bold">R</div><span class="font-bold text-xl text-slate-900">Rentify</span></div>
        <nav class="space-y-1 flex-1">
            <button onclick="switchTab('overview')" id="nav-overview" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-600 transition"><i class="fa-solid fa-grid-2"></i> Dashboard</button>
            <button onclick="switchTab('products')" id="nav-products" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-600 transition"><i class="fa-solid fa-box"></i> Inventory</button>
        </nav>
        <button onclick="logout()" class="mt-auto w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 font-medium"><i class="fa-solid fa-power-off"></i> Logout</button>
      </aside>

      <main class="flex-1 flex flex-col h-screen relative bg-[#F8FAFC]">
        <header class="h-20 px-8 flex items-center justify-between sticky top-0 z-10 bg-[#F8FAFC]/90 backdrop-blur-sm">
            <h1 class="text-xl font-bold text-slate-900">Dashboard</h1>
            <div class="flex items-center gap-4">
                <span id="plan-badge" class="px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full">FREE</span>
                <button onclick="openAddModal()" class="bg-[#1F2937] text-white px-5 py-2.5 rounded-full font-medium shadow-lg hover:scale-105 transition"><i class="fa-solid fa-plus"></i> Add Item</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 pb-24 space-y-8" id="main-container">
            <div id="tab-overview" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-[#064E3B] text-white p-6 rounded-[24px] shadow-xl relative overflow-hidden">
                        <span class="opacity-80 text-sm">Total Products</span>
                        <h2 class="text-4xl font-bold mt-2" id="stat-products">0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-[24px] shadow-sm border border-slate-100">
                        <span class="text-slate-500 text-sm font-bold">Active Rentals</span>
                        <h2 class="text-4xl font-bold mt-2 text-slate-800" id="stat-active">0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-[24px] shadow-sm border border-slate-100">
                        <span class="text-slate-500 text-sm font-bold">Earnings</span>
                        <h2 class="text-3xl font-bold mt-2 text-slate-800">₹<span id="stat-earnings">0</span></h2>
                    </div>
                </div>
                <div class="bg-white rounded-[24px] p-6 shadow-sm border border-slate-100">
                    <h3 class="font-bold mb-4">Recent Bookings</h3>
                    <div id="tracking-list" class="space-y-2 text-sm text-slate-500">Loading...</div>
                </div>
            </div>
            <div id="tab-products" class="hidden"><div id="products-grid" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div></div>
        </div>
      </main>
  </div>

  <div id="modal-add" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-[24px] shadow-2xl p-6">
        <h3 class="font-bold text-xl mb-6">New Product</h3>
        <form id="form-add" class="space-y-4">
            <input type="text" id="inp-name" required placeholder="Name" class="w-full p-3 border rounded-xl bg-slate-50">
            <input type="number" id="inp-price" required placeholder="Rent (₹)" class="w-full p-3 border rounded-xl bg-slate-50">
            <select id="inp-category" class="w-full p-3 border rounded-xl bg-slate-50"><option>Electronics</option><option>Cameras</option><option>Tools</option></select>
            <textarea id="inp-desc" placeholder="Details..." class="w-full p-3 border rounded-xl bg-slate-50"></textarea>
            <input type="file" id="inp-file" accept="image/*" class="text-xs">
            <button type="submit" id="btn-publish" class="w-full py-3 bg-[#064E3B] text-white font-bold rounded-xl shadow-lg">Publish</button>
        </form>
        <button onclick="closeAddModal()" class="mt-4 w-full text-sm text-slate-400">Cancel</button>
    </div>
  </div>

<script type="module">
    // 1. EMBEDDED CONFIG & IMPORTS (Guaranteed Loading)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, query, where, orderBy, getDocs, serverTimestamp, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZHr-xXgx3tLnsUfF2RPxppZjE6cvirNY",
      authDomain: "rentify-93c05.firebaseapp.com",
      projectId: "rentify-93c05",
      storageBucket: "rentify-93c05.firebasestorage.app",
      messagingSenderId: "652243130812",
      appId: "1:652243130812:web:628fd64b4a69628eae73b9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;

    // 2. AUTH & GATEKEEPER
    onAuthStateChanged(auth, async (user) => {
        if (!user) return window.location.href = "loginpage.html";
        currentUser = user;
        
        try {
            const snap = await getDoc(doc(db, "partners", currentUser.uid));
            document.getElementById('state-loading').style.display = 'none';

            let status = 'new';
            if (snap.exists()) status = snap.data().verificationStatus || 'new';

            if (status === 'approved') {
                document.getElementById('main-body').className = "bg-dashboard-mode h-screen overflow-hidden";
                document.getElementById('view-verification').classList.add('hidden-force');
                document.getElementById('view-dashboard').classList.remove('hidden-force');
                startDashboard();
            } else if (status === 'submitted') {
                document.getElementById('state-pending').classList.remove('hidden-force');
            } else {
                document.getElementById('state-form').classList.remove('hidden-force');
            }
        } catch (e) {
            console.error(e);
            document.getElementById('state-loading').style.display = 'none';
            document.getElementById('state-form').classList.remove('hidden-force');
        }
    });

    // 3. IMAGE COMPRESSOR (Smart Resize: <50KB Guaranteed)
    const compressImage = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    // Force small width (500px is safe for ID cards on screen)
                    const MAX_WIDTH = 500; 
                    const scale = MAX_WIDTH / img.width; 
                    canvas.width = MAX_WIDTH; 
                    canvas.height = img.height * scale;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // 0.6 Quality keeps it legible but very small file size
                    resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                }
            }
        });
    };

    // 4. SUBMIT APPLICATION (Uses Compressor)
    document.getElementById('form-verify').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-submit-app');
        btn.innerHTML = 'Compressing & Sending...'; btn.disabled = true;

        try {
            const file = document.getElementById('v-file-doc').files[0];
            if(!file) throw new Error("Select ID/License image");

            // Compress to Base64 String (Bypasses Storage 1MB Limit)
            const base64 = await compressImage(file); 

            await setDoc(doc(db, "partners", currentUser.uid), {
                businessName: document.getElementById('v-biz-name').value,
                businessAddress: document.getElementById('v-biz-addr').value,
                verificationDoc: base64, // Saves image as text string
                verificationStatus: 'submitted',
                email: currentUser.email,
                submittedAt: serverTimestamp()
            }, { merge: true });

            alert("Application Submitted Successfully!");
            location.reload();
        } catch(e) { 
            alert("Error: " + e.message); 
            btn.disabled=false; 
            btn.innerHTML='Submit Application'; 
        }
    });

    // 5. DASHBOARD LOGIC (Runs after approval)
    function startDashboard() {
        onSnapshot(query(collection(db, "bookings"), where("partnerId", "==", currentUser.uid)), snap => {
            let active=0, earnings=0;
            const list = document.getElementById('tracking-list');
            if(list) list.innerHTML = "";
            snap.forEach(d => {
                const b = d.data();
                if(b.status==='active') active++;
                if(b.totalPrice) earnings+=b.totalPrice;
                if(list && b.status==='active') {
                    list.innerHTML += `<div class="p-3 bg-slate-50 border rounded mb-2 flex justify-between"><span>${b.productName}</span><span class="text-green-600 font-bold">ACTIVE</span></div>`;
                }
            });
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-earnings').textContent = earnings.toLocaleString();
        });
        
        onSnapshot(query(collection(db, "products"), where("partnerId", "==", currentUser.uid)), snap => {
            document.getElementById('stat-products').textContent = snap.size;
            const grid = document.getElementById('products-grid'); if(grid) grid.innerHTML="";
            snap.forEach(d => {
                const p = d.data();
                grid.innerHTML += `<div class="bg-white p-4 rounded-xl shadow border"><img src="${p.imageUrl}" class="h-32 w-full object-cover rounded mb-2"><h4 class="font-bold">${p.name}</h4><div class="text-xs">₹${p.rentPerDay}</div></div>`;
            });
        });
    }

    // 6. ADD PRODUCT (Uses Compressor)
    document.getElementById('form-add').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const file = document.getElementById('inp-file').files[0];
            const base64 = await compressImage(file);
            await addDoc(collection(db, "products"), {
                partnerId: currentUser.uid,
                name: document.getElementById('inp-name').value,
                rentPerDay: Number(document.getElementById('inp-price').value),
                category: document.getElementById('inp-category').value,
                description: document.getElementById('inp-desc').value,
                imageUrl: base64,
                status: "published",
                createdAt: serverTimestamp()
            });
            alert("Published!"); window.closeAddModal();
        } catch(e) { alert(e.message); }
    });

    // HELPERS
    window.switchTab = (t) => {
        ['overview','products'].forEach(id => { document.getElementById(`tab-${id}`).classList.add('hidden'); document.getElementById(`nav-${id}`).classList.remove('active','bg-[#064E3B]','text-white'); });
        document.getElementById(`tab-${t}`).classList.remove('hidden'); document.getElementById(`nav-${t}`).classList.add('active','bg-[#064E3B]','text-white');
    };
    window.openAddModal = () => document.getElementById('modal-add').classList.remove('hidden');
    window.closeAddModal = () => document.getElementById('modal-add').classList.add('hidden');
    window.logout = () => signOut(auth).then(() => window.location.href = "loginpage.html");
</script>
</body>
</html>