<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rentify Partner Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; }

    .hidden-force { display: none !important; }
    
    /* THEME STYLES */
    .bg-video-mode { background-color: #020617; color: white; }
    .video-bg { position: fixed; top: 50%; left: 50%; min-width: 100%; min-height: 100%; width: auto; height: auto; z-index: -10; transform: translate(-50%, -50%); object-fit: cover; }
    .video-overlay { position: fixed; inset: 0; z-index: -5; background: radial-gradient(circle at 50% 50%, rgba(2, 6, 23, 0.6) 0%, rgba(2, 6, 23, 0.95) 90%); }
    .glass-modal { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); }

    .dashboard-container { display: flex; height: 100vh; background-color: #F3F4F6; color: #111827; }
    
    /* SIDEBAR */
    .sidebar { width: 260px; background-color: #111827; color: #9CA3AF; display: flex; flex-direction: column; flex-shrink: 0; transition: all 0.3s; }
    .sidebar-logo { color: white; font-weight: 700; font-size: 1.25rem; padding: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
    
    .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-link:hover { color: white; background-color: rgba(255,255,255,0.05); }
    .nav-link.active { color: white; background-color: rgba(255,255,255,0.05); border-left-color: #3b82f6; }
    .nav-section { text-transform: uppercase; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.05em; padding: 1.5rem 1.5rem 0.5rem; opacity: 0.5; }
    .badge { background-color: #ef4444; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; margin-left: auto; }

    /* CONTENT */
    .main-content { flex: 1; overflow-y: auto; padding: 2rem; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .card-dark { background: #111827; color: white; }

    /* SUBSCRIPTION CARDS */
    .sub-card {
        background: #0F172A; 
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 1.5rem;
        padding: 2rem;
        color: white;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .sub-card:hover { transform: translateY(-5px); border-color: #3b82f6; box-shadow: 0 20px 40px -10px rgba(59, 130, 246, 0.2); }
    .sub-card.active-plan { border: 2px solid #3b82f6; background: #1e293b; }
    .plan-badge { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: #60A5FA; border: 1px solid rgba(96, 165, 250, 0.2); padding: 4px 8px; border-radius: 6px; display: inline-block; margin-bottom: 1rem; }
    
    /* TABLES */
    .table-container { overflow-x: auto; background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    table { width: 100%; text-align: left; border-collapse: collapse; }
    th { padding: 1rem; font-size: 0.8rem; text-transform: uppercase; color: #6B7280; font-weight: 600; border-bottom: 1px solid #E5E7EB; }
    td { padding: 1rem; font-size: 0.9rem; border-bottom: 1px solid #F3F4F6; color: #374151; }

    /* MODERN FILE UPLOAD */
    .upload-area { border: 2px dashed #e2e8f0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
    .upload-area:hover { border-color: #3b82f6; background: #f8fafc; transform: scale(1.01); }
  </style>
</head>
<body id="main-body" class="bg-video-mode h-screen overflow-hidden">

  <div id="view-verification" class="flex flex-col items-center justify-center h-full p-4 relative w-full">
      <video autoplay muted loop playsinline class="video-bg"><source src="Video_Generation_Request.mp4" type="video/mp4"></video>
      <div class="video-overlay"></div>

      <div id="state-loading" class="text-center">
          <i class="fa-solid fa-circle-notch fa-spin text-4xl text-emerald-500 mb-4"></i>
          <h2 class="text-xl font-medium tracking-wide">Connecting...</h2>
      </div>

      <div id="state-form" class="hidden-force w-full max-w-xl glass-modal rounded-3xl p-8">
          <div class="mb-6"><h1 class="text-2xl font-bold">Partner Application</h1><p class="text-slate-400 text-sm">Submit details to activate your seller account.</p></div>
          <form id="form-verify" class="space-y-4">
              <input type="text" id="v-biz-name" required class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none" placeholder="Business Name">
              <input type="text" id="v-biz-addr" required class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none" placeholder="Location">
              <div class="p-4 bg-slate-800/50 rounded-xl border border-dashed border-slate-600">
                  <label class="block text-xs font-bold text-slate-400 uppercase mb-2">ID Proof (Image &lt; 50KB)</label>
                  <input type="file" id="v-file-doc" required accept="image/*" class="text-sm text-slate-400 w-full cursor-pointer">
              </div>
              <button type="submit" id="btn-submit-app" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transition">Submit Application</button>
          </form>
          <button onclick="logout()" class="w-full mt-4 text-xs text-slate-500 hover:text-white">Logout</button>
      </div>

      <div id="state-pending" class="hidden-force text-center max-w-md glass-modal p-10 rounded-3xl">
          <i class="fa-solid fa-clock text-4xl text-yellow-400 mb-4"></i>
          <h2 class="text-2xl font-bold mb-2 text-white">Verification Pending</h2>
          <p class="text-slate-400 mb-6 text-sm">Your application is being reviewed.</p>
          <button onclick="location.reload()" class="px-6 py-2 bg-white/10 hover:bg-white/20 rounded-full text-sm font-medium transition text-white">Refresh Status</button>
          <div class="mt-4"><button onclick="logout()" class="text-xs text-slate-500 hover:text-white">Logout</button></div>
      </div>
  </div>

  <div id="view-dashboard" class="hidden-force dashboard-container">
      
      <aside class="sidebar">
          <div class="sidebar-logo"><i class="fa-brands fa-react text-2xl text-blue-500"></i> Rentify.</div>
          
          <div class="flex flex-col gap-1 mt-4">
              <div class="nav-section">Dashboard</div>
              <div onclick="switchTab('overview')" id="nav-overview" class="nav-link active"><i class="fa-solid fa-chart-pie w-5 text-center"></i> Summary</div>
              <div onclick="switchTab('rent-requests')" id="nav-rent-requests" class="nav-link"><i class="fa-solid fa-bell w-5 text-center text-orange-500"></i> Rent Requests <span id="badge-requests" class="badge hidden">0</span></div>
              <div onclick="switchTab('products')" id="nav-products" class="nav-link"><i class="fa-solid fa-box w-5 text-center"></i> Products</div>
              <div onclick="switchTab('store')" id="nav-store" class="nav-link"><i class="fa-solid fa-shop w-5 text-center"></i> Store Customization</div>
              <div onclick="switchTab('subscriptions')" id="nav-subscriptions" class="nav-link"><i class="fa-solid fa-crown w-5 text-center"></i> Subscription Plan</div>
          </div>

          <div class="flex flex-col gap-1">
              <div class="nav-section">Management</div>
              <div onclick="switchTab('messages')" id="nav-messages" class="nav-link"><i class="fa-solid fa-envelope w-5 text-center"></i> Messages <span id="badge-msg" class="badge">0</span></div>
              <div onclick="switchTab('orders')" id="nav-orders" class="nav-link"><i class="fa-solid fa-receipt w-5 text-center"></i> Orders <span id="badge-orders" class="badge">0</span></div>
              <div onclick="switchTab('customers')" id="nav-customers" class="nav-link"><i class="fa-solid fa-users w-5 text-center"></i> Customers</div>
          </div>

          <div class="mt-auto p-4 border-t border-gray-800 space-y-2">
             <div onclick="window.resetData()" class="nav-link text-yellow-500 hover:bg-yellow-900/20 rounded-lg cursor-pointer"><i class="fa-solid fa-eraser w-5 text-center"></i> Reset Data</div>
             <div onclick="logout()" class="nav-link text-red-400 hover:bg-red-900/20 rounded-lg cursor-pointer"><i class="fa-solid fa-arrow-right-from-bracket w-5 text-center"></i> Logout</div>
          </div>
      </aside>

      <div class="main-content">
          <div class="header">
              <div><h1 class="text-2xl font-bold">Partner Dashboard</h1><p class="text-sm text-gray-500">Manage your business & inventory.</p></div>
              <div class="flex items-center bg-white p-1 rounded-xl shadow-sm border border-gray-200">
                  <button onclick="visitMyStore()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition"><i class="fa-solid fa-external-link-alt"></i> Visit My Store</button>
                  <div class="w-px h-6 bg-gray-200 mx-1"></div>
                  <button onclick="openAddModal()" class="flex items-center gap-2 px-5 py-2 bg-black text-white rounded-lg text-sm font-bold shadow-md hover:bg-gray-800 transition">+ Add Item</button>
              </div>
          </div>

          <div id="tab-overview" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div class="card card-dark"><p class="text-gray-400 text-sm">Total Sales</p><h2 class="text-3xl font-bold mt-1">₹<span id="val-earnings">0</span></h2></div>
                  <div class="card"><p class="text-gray-500 text-sm">Customers Rented</p><h2 class="text-3xl font-bold mt-1" id="val-customers">0</h2></div>
                  <div class="card"><p class="text-gray-500 text-sm">Total Orders</p><h2 class="text-3xl font-bold mt-1" id="val-orders">0</h2></div>
              </div>
              <div class="card h-64"><canvas id="salesChart"></canvas></div>
          </div>

          <div id="tab-rent-requests" class="hidden">
              <h2 class="text-xl font-bold mb-6">Pending Rental Requests</h2>
              <div class="table-container">
                  <table>
                      <thead><tr><th>Customer Details</th><th>Product</th><th>ID Proof</th><th>Duration</th><th>Total Price</th><th>Action</th></tr></thead>
                      <tbody id="requests-list-body"></tbody>
                  </table>
              </div>
          </div>

          <div id="tab-products" class="hidden">
              <h2 class="text-xl font-bold mb-6">Inventory</h2>
              <div id="products-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
          </div>

          <div id="tab-store" class="hidden">
              <h2 class="text-xl font-bold mb-6">Store Customization</h2>
              <div class="card">
                  <form id="form-store-settings">
                      <div class="relative w-full h-48 bg-slate-100 rounded-xl overflow-hidden border-2 border-dashed border-slate-300 group cursor-pointer" onclick="document.getElementById('inp-cover').click()">
                          <img id="preview-cover" src="" class="w-full h-full object-cover hidden">
                          <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400"><i class="fa-regular fa-image text-3xl mb-2"></i><span class="text-sm font-medium">Upload Cover Photo</span></div>
                          <input type="file" id="inp-cover" accept="image/*" class="hidden" onchange="previewImage(this, 'preview-cover')">
                      </div>
                      <div class="mt-6 flex justify-end"><button type="submit" id="btn-save-store" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold">Save Changes</button></div>
                  </form>
              </div>
          </div>

          <div id="tab-subscriptions" class="hidden">
              <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6" id="plans-container">
                  <div class="sub-card" id="plan-card-starter"><div class="plan-badge">LEVEL 01</div><h3 class="text-3xl font-black mb-1 text-white">Starter</h3><p class="text-slate-400 text-sm min-h-[40px] mb-6">Entry-level plan for new businesses starting their rental journey.</p><button onclick="upgradePlan('starter')" class="w-full py-3 bg-white text-black rounded-lg font-bold mt-4">Select Starter</button></div>
                  <div class="sub-card" id="plan-card-growth"><div class="plan-badge">LEVEL 02</div><h3 class="text-3xl font-black mb-1 text-white">Growth</h3><p class="text-slate-400 text-sm min-h-[40px] mb-6">For growing businesses needing more flexibility and reach.</p><button onclick="upgradePlan('growth')" class="w-full py-3 bg-white text-black rounded-lg font-bold mt-4">Select Growth</button></div>
                  <div class="sub-card" id="plan-card-business"><div class="plan-badge">LEVEL 03</div><h3 class="text-3xl font-black mb-1 text-white">Business</h3><p class="text-slate-400 text-sm min-h-[40px] mb-6">Robust tools for established rental enterprises.</p><button onclick="upgradePlan('business')" class="w-full py-3 bg-white text-black rounded-lg font-bold mt-4">Select Business</button></div>
                  <div class="sub-card" id="plan-card-enterprise"><div class="plan-badge">LEVEL 04</div><h3 class="text-3xl font-black mb-1 text-white">Enterprise</h3><p class="text-slate-400 text-sm min-h-[40px] mb-6">Full customization for large scale operations.</p><button onclick="upgradePlan('enterprise')" class="w-full py-3 bg-white text-black rounded-lg font-bold mt-4">Select Enterprise</button></div>
              </div>
          </div>

          <div id="tab-messages" class="hidden"><h2 class="text-xl font-bold mb-6 text-black">Booking & Rental Notifications</h2><div class="card p-0 overflow-hidden"><div id="messages-list" class="divide-y divide-gray-100"></div></div></div>
          <div id="tab-orders" class="hidden"><h2 class="text-xl font-bold mb-6">Orders</h2><div class="table-container"><table><thead><tr><th>Order ID</th><th>Product</th><th>Amount</th><th>Status</th></tr></thead><tbody id="orders-table-body"></tbody></table></div></div>
          <div id="tab-customers" class="hidden"><h2 class="text-xl font-bold mb-6">Customers</h2><div class="table-container"><table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Spent</th></tr></thead><tbody id="customers-table-body"></tbody></table></div></div>
      </div>
  </div>

  <div id="modal-add" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
        <div class="p-6 border-b flex justify-between items-center"><h3 class="font-bold text-xl">New Listing</h3><button onclick="closeAddModal()" class="text-slate-400 hover:text-slate-900"><i class="fa-solid fa-xmark text-xl"></i></button></div>
        <form id="form-add" class="p-6 space-y-5 overflow-y-auto max-h-[80vh]">
            <div id="drop-zone" class="upload-area rounded-2xl p-8 text-center" onclick="document.getElementById('inp-file').click()">
                <div id="upload-placeholder"><i class="fa-solid fa-cloud-arrow-up text-4xl text-blue-500 mb-3"></i><p class="text-sm font-bold text-slate-700">Drop Product Image here</p></div>
                <img id="upload-preview" class="hidden w-full h-40 object-contain rounded-lg">
                <input type="file" id="inp-file" accept="image/*" class="hidden">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2"><input type="text" id="inp-name" required placeholder="Product Name" class="w-full p-3 border rounded-xl bg-slate-50 outline-none"></div>
                <div><input type="number" id="inp-price" required placeholder="Daily Rent (₹)" class="w-full p-3 border rounded-xl bg-slate-50 outline-none"></div>
                <div><input type="number" id="inp-security" required placeholder="Security Deposit (₹)" class="w-full p-3 border rounded-xl bg-slate-50 outline-none"></div>
                <div><input type="number" id="inp-stock" value="1" min="1" required class="w-full p-3 border rounded-xl bg-slate-50 outline-none"></div>
                <div><select id="inp-category" class="w-full p-3 border rounded-xl bg-slate-50 outline-none"><option>Electronics</option><option>Cameras</option><option>Tools</option><option>Vehicles</option></select></div>
            </div>
            <textarea id="inp-desc" placeholder="Description..." rows="3" class="w-full p-3 border rounded-xl bg-slate-50 outline-none"></textarea>
            <button type="submit" id="btn-publish" class="w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg hover:bg-blue-700 transition">Publish Item</button>
        </form>
    </div>
    <div class="mt-4 mb-2 text-center">
  <p class="text-[10px] text-slate-400">
    By registering, you agree to our 
    <a href="privacy.html" class="text-slate-900 font-bold underline decoration-emerald-500">Privacy Policy</a>.
  </p>
</div>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, setDoc, getDoc, getDocs, updateDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyDZHr-xXgx3tLnsUfF2RPxppZjE6cvirNY", authDomain: "rentify-93c05.firebaseapp.com", projectId: "rentify-93c05", storageBucket: "rentify-93c05.firebasestorage.app", messagingSenderId: "652243130812", appId: "1:652243130812:web:628fd64b4a69628eae73b9" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
    let currentUser = null; let salesChartInstance = null;

    onAuthStateChanged(auth, async (user) => {
        if (!user) return window.location.href = "loginpage.html";
        currentUser = user;
        try {
            const snap = await getDoc(doc(db, "partners", currentUser.uid));
            document.getElementById('state-loading').style.display = 'none';
            let status = snap.exists() ? (snap.data().verificationStatus || 'new') : 'new';
            if (status === 'approved') {
                document.getElementById('main-body').className = "h-screen overflow-hidden bg-gray-50"; 
                document.getElementById('view-verification').classList.add('hidden-force');
                document.getElementById('view-dashboard').classList.remove('hidden-force');
                highlightCurrentPlan(snap.exists() ? snap.data().plan : 'starter'); startDashboard();
            } else if (status === 'submitted') {
                document.getElementById('state-pending').classList.remove('hidden-force');
            } else {
                document.getElementById('state-form').classList.remove('hidden-force');
            }
        } catch (e) { document.getElementById('state-loading').style.display = 'none'; }
    });

    function startDashboard() {
        // UPDATED: COMBINED LOGIC FOR REQUESTS, ORDERS, AND MESSAGE NOTIFICATIONS
        onSnapshot(query(collection(db, "booking_requests"), where("partnerId", "==", currentUser.uid)), (snap) => {
            const listBody = document.getElementById('requests-list-body');
            const msgList = document.getElementById('messages-list');
            const badgeRequests = document.getElementById('badge-requests');
            const msgBadge = document.getElementById('badge-msg');
            const tbodyOrders = document.getElementById('orders-table-body');
            const tbodyCust = document.getElementById('customers-table-body');
            const badgeOrders = document.getElementById('badge-orders');
            
            listBody.innerHTML = ""; msgList.innerHTML = ""; tbodyOrders.innerHTML = ""; tbodyCust.innerHTML = "";
            let pendingCount = 0; let approvedCount = 0; let revenue = 0; const custs = {};

            if (snap.empty) {
                listBody.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-slate-400">No requests</td></tr>`;
                msgList.innerHTML = `<div class="p-8 text-center text-gray-400">No new messages.</div>`;
                badgeRequests.classList.add('hidden'); msgBadge.innerText = "0"; return;
            }

            snap.forEach(d => {
                const r = d.data();
                const today = new Date().toISOString().split('T')[0];

                // 1. Logic for "Rent Requests" Tab (Submitted only)
                if (r.status === 'submitted') {
                    pendingCount++;
                    listBody.innerHTML += `
                        <tr class="hover:bg-slate-50 border-b">
                            <td class="p-4 font-bold text-sm text-black">${r.customerName || "Customer"}<br><span class="text-[10px] text-emerald-600 font-bold">${r.customerPhone || 'N/A'}</span></td>
                            <td class="p-4 text-sm font-medium uppercase text-black">${r.productName}</td>
                            <td class="p-4">${r.customerAadhar ? `<img src="${r.customerAadhar}" class="h-8 w-12 object-cover rounded cursor-pointer" onclick="const w=window.open(); w.document.write('<img src=\\'${r.customerAadhar}\\' style=\\'width:100%\\'>');">` : 'N/A'}</td>
                            <td class="p-4 text-xs font-bold text-gray-400">${r.startDate} to ${r.endDate}</td>
                            <td class="p-4 font-black">₹${r.totalPrice}</td>
                            <td class="p-4 flex gap-2 justify-center">
                                <button onclick="handleRequest('${d.id}', 'approved')" class="bg-black text-white px-4 py-2 rounded-full text-[10px] font-black uppercase">Approve</button>
                                <button onclick="handleRequest('${d.id}', 'rejected')" class="bg-red-500 text-white px-4 py-2 rounded-full text-[10px] font-black uppercase">Reject</button>
                            </td>
                        </tr>`;
                    
                    // Add Message for New Request
                    msgList.innerHTML += createMsgUI("New Rental Request", `${r.customerName} wants to rent ${r.productName}`, "blue");
                }

                // 2. Logic for "Orders" and "Customers" (Approved only)
                if (r.status === 'approved') {
                    approvedCount++;
                    revenue += parseFloat(r.totalPrice);
                    tbodyOrders.innerHTML += `<tr class="border-b"><td class="p-4 font-mono text-xs">#${d.id.substring(0,6)}</td><td class="p-4 font-bold text-xs uppercase">${r.productName}</td><td class="p-4 font-black text-black">₹${r.totalPrice}</td><td class="p-4 text-[10px] font-black text-blue-500 uppercase">Active</td></tr>`;
                    
                    if(!custs[r.customerId]) custs[r.customerId] = { name: r.customerName, email: r.customerEmail, phone: r.customerPhone, total: 0 };
                    custs[r.customerId].total += parseFloat(r.totalPrice);

                    // Add Message for Approved Order
                    msgList.innerHTML += createMsgUI("Order Confirmed", `Rental for ${r.productName} by ${r.customerName} is active.`, "green");

                    // 3. Logic for "Last Date Reminder"
                    if (r.endDate === today) {
                        msgList.innerHTML += createMsgUI("Return Reminder", `TODAY is the last day for ${r.productName} (Customer: ${r.customerName}).`, "orange");
                    }
                }
            });

            // Update Badges and Stats
            badgeRequests.innerText = pendingCount;
            badgeRequests.classList.toggle('hidden', pendingCount === 0);
            msgBadge.innerText = snap.size;
            badgeOrders.innerText = approvedCount;
            document.getElementById('val-earnings').textContent = revenue.toLocaleString();
            document.getElementById('val-orders').textContent = approvedCount;
            document.getElementById('val-customers').textContent = Object.keys(custs).length;

            Object.values(custs).forEach(c => {
                tbodyCust.innerHTML += `<tr class="border-b"><td class="p-4 font-black uppercase text-xs text-black">${c.name}</td><td class="p-4 text-xs text-black">${c.email}</td><td class="p-4 font-bold text-xs text-black">${c.phone}</td><td class="p-4 font-black text-black">₹${c.total}</td></tr>`;
            });

            updateChart(revenue);
        });

        // INVENTORY LISTENER
        onSnapshot(query(collection(db, "products"), where("partnerId", "==", currentUser.uid)), (snap) => {
            const grid = document.getElementById('products-grid'); grid.innerHTML = "";
            snap.forEach(d => {
                const p = d.data(); const stock = p.stock || 0;
                grid.innerHTML += `
                    <div class="card group relative border-none bg-gray-50 shadow-none ${stock <= 0 ? 'opacity-50 grayscale' : ''}">
                        <button onclick="window.deleteProduct('${d.id}')" class="absolute top-4 left-4 w-8 h-8 bg-white rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition z-10 text-red-500"><i class="fa-solid fa-trash-can text-xs"></i></button>
                        <div class="h-40 overflow-hidden rounded-xl bg-gray-200 mb-4"><img src="${p.imageUrl}" class="w-full h-full object-cover"></div>
                        <div class="flex justify-between items-start mb-1"><h4 class="font-black text-xs uppercase truncate text-black">${p.name}</h4><span class="text-[9px] font-black px-2 py-0.5 rounded-full ${stock > 0 ? 'bg-black text-white' : 'bg-red-500 text-white'}">${stock > 0 ? stock + ' IN STOCK' : 'OUT'}</span></div>
                        <div class="flex justify-between text-[10px] text-gray-400 font-bold uppercase tracking-tighter"><span>₹${p.rentPerDay}/Day</span><span>Dep: ₹${p.securityDeposit || 0}</span></div>
                    </div>`;
            });
        });
    }

    // Helper function for creating Message UI
    function createMsgUI(title, body, color) {
        const colors = { blue: "bg-blue-100 text-blue-600", green: "bg-green-100 text-green-600", orange: "bg-orange-100 text-orange-600" };
        return `
            <div class="p-4 flex items-center gap-4 hover:bg-slate-50 transition border-b border-gray-100">
                <div class="w-10 h-10 rounded-full ${colors[color] || colors.blue} flex items-center justify-center font-bold">!</div>
                <div class="flex-1">
                    <h4 class="font-bold text-sm text-black uppercase">${title}</h4>
                    <p class="text-xs text-gray-500">${body}</p>
                </div>
            </div>`;
    }

    window.handleRequest = async (id, status) => {
        if(!confirm(`Confirm Action?`)) return;
        const ref = doc(db, "booking_requests", id);
        if(status === 'approved') {
            const reqSnap = await getDoc(ref);
            const pRef = doc(db, "products", reqSnap.data().productId);
            const pSnap = await getDoc(pRef);
            if((pSnap.data().stock || 0) <= 0) return alert("ITEM OUT OF STOCK");
            await updateDoc(pRef, { stock: pSnap.data().stock - 1 });
        }
        await updateDoc(ref, { status: status });
    };

    const inpFile = document.getElementById('inp-file');
    inpFile.onchange = () => { if(inpFile.files[0]) { const r = new FileReader(); r.onload=e=>{const preview = document.getElementById('upload-preview'); preview.src=e.target.result; preview.classList.remove('hidden'); document.getElementById('upload-placeholder').classList.add('hidden');}; r.readAsDataURL(inpFile.files[0]); } };

    document.getElementById('form-add').addEventListener('submit', async (e) => {
        e.preventDefault(); const btn = document.getElementById('btn-publish'); btn.disabled = true;
        try {
            const base64 = inpFile.files[0] ? await compressImage(inpFile.files[0]) : "https://placehold.co/400";
            await addDoc(collection(db, "products"), {
                partnerId: currentUser.uid, name: document.getElementById('inp-name').value, 
                rentPerDay: Number(document.getElementById('inp-price').value),
                securityDeposit: Number(document.getElementById('inp-security').value),
                stock: Number(document.getElementById('inp-stock').value),
                category: document.getElementById('inp-category').value, imageUrl: base64, status: "published", createdAt: serverTimestamp()
            });
            closeAddModal(); document.getElementById('form-add').reset(); document.getElementById('upload-preview').classList.add('hidden'); document.getElementById('upload-placeholder').classList.remove('hidden');
        } catch(err) { alert(err.message); } finally { btn.disabled = false; }
    });

    window.resetData = async () => {
        if(!confirm("WIPE DASHBOARD?")) return;
        const cols = ["products", "booking_requests"];
        for(const c of cols) {
            const snap = await getDocs(query(collection(db, c), where("partnerId", "==", currentUser.uid)));
            await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
        }
        location.reload();
    };

    window.switchTab = (t) => { document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active')); document.getElementById(`nav-${t}`).classList.add('active'); ['overview','products','messages','orders','customers','store','subscriptions','rent-requests'].forEach(id=>document.getElementById(`tab-${id}`)?.classList.add('hidden')); document.getElementById(`tab-${t}`).classList.remove('hidden'); };
    function highlightCurrentPlan(p) { document.querySelectorAll('.sub-card').forEach(el=>el.classList.remove('active-plan')); const activeCard = document.getElementById(`plan-card-${p}`); if(activeCard) { activeCard.classList.add('active-plan'); const btn = activeCard.querySelector('button'); if(btn) { btn.innerText = "Current Plan"; btn.disabled = true; btn.className = "w-full py-3 bg-blue-600/20 text-blue-400 border border-blue-600/50 rounded-lg font-bold cursor-default"; } } }
    window.upgradePlan = async (p) => { if(confirm(`Switch to ${p}?`)) { await updateDoc(doc(db, "partners", currentUser.uid), { plan: p }); location.reload(); } };
    window.openAddModal = () => document.getElementById('modal-add').classList.remove('hidden');
    window.closeAddModal = () => document.getElementById('modal-add').classList.add('hidden');
    window.deleteProduct = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "products", id)); };
    window.logout = () => signOut(auth).then(()=>window.location.href="loginpage.html");
    window.visitMyStore = () => { if(currentUser) window.open(`store.html?id=${currentUser.uid}`, '_blank'); };
    function previewImage(input, imgId) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload=e=>{const img=document.getElementById(imgId); img.src=e.target.result; img.classList.remove('hidden');}; r.readAsDataURL(input.files[0]); } }
    const compressImage = (f) => new Promise((resolve) => { const r = new FileReader(); r.readAsDataURL(f); r.onload = (e) => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); c.width=500; c.height=500; c.getContext('2d').drawImage(i,0,0,500,500); resolve(c.toDataURL('image/jpeg', 0.6)); } } });
    function updateChart(e){ const ctx = document.getElementById('salesChart'); if(!ctx) return; if(salesChartInstance) salesChartInstance.destroy(); salesChartInstance = new Chart(ctx, { type:'line', data:{ labels:['W1','W2','W3','Today'], datasets:[{label:'Revenue', data:[0,e*0.3,e*0.6,e], borderColor:'#000', backgroundColor:'rgba(0,0,0,0.05)', fill:true, tension:0.4}] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} } }); }
</script>
</body>
</html>